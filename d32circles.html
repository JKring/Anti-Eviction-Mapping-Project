<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Easy earthquakes</title>
    <link rel="stylesheet" href="css/jquery-ui.min.css">
    <script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>
    <script src="http://libs.cartocdn.com/cartodb.js/v2/cartodb.js"></script>
     <script src="js/jquery.ui.core.js"></script>
  <script src="js/jquery.ui.widget.js"></script>
  <script src="js/jquery.ui.mouse.js"></script>
  <script src="js/jquery.ui.slider.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->

<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <style type="text/css">
html, body, #map {
      position: relative;
      height: 100%;
      padding: 0;
      margin: 0;
    }

 .box {
      position: absolute;
     bottom: 100px;
     right: 100px;
      background-color: rgba(255, 255, 255, 0.8);
      font: bold 50px "Helvetica Neue";
      padding: 3px 10px;
      width: 400px;
    }
   #counter{
      /*position: absolute;
      top: 400px;
      left: 100px;
      background-color: rgba(255, 255, 255, 0.8);*/
      font: 18px "Helvetica Neue";
      /*padding: 3px 10px;*/
    }
   
path {
  fill: #f00;
  fill-opacity: .5;
  stroke: #fff;
  stroke-width: 1.5px;
}

path:hover {
  fill: brown;
   stroke: #fff;
  fill-opacity: .7;
}

circle {
      fill: #f00;
      stroke-width: .5px;
      fill-opacity: .7;
      stroke: #FFF;
}
 
    </style>
  </head>
  <body>
    <div id = "map"></div>
     <div class="box">
      <div id="date"></div>
      <div id="counter"></div>
       <div id="slider"></div>
  </div>
    <script type="text/javascript">
 
 var map = new L.Map("map", {
      center: [37.7756, -122.4193],
      zoom: 13
    })
    .addLayer(new L.TileLayer("http://{s}.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/998/256/{z}/{x}/{y}.png"));

/* Initialize the SVG layer */
  map._initPathRoot()    

  /* We simply pick up the SVG from the map object */
  var svg = d3.select("#map").select("svg"),
  g = svg.append("g");

var animationTime = 3600*4*1000*1000;

   var sql = new cartodb.SQL({ user: 'ojack', format: 'geojson'});
 
  
    sql.execute("SELECT the_geom, date_filed FROM {{table_name}} WHERE the_geom IS NOT NULL ORDER BY date_filed ASC", {table_name: 'sf_ellis_petitions'})
      .done(function(collection) {

        collection.features.forEach(function(d) {
      d.LatLng = new L.LatLng(d.geometry.coordinates[1],d.geometry.coordinates[0])
    })
  
    /*var secondFeature = g.selectAll("circle") .data(collection.features)
      .enter().append("circle").attr("r", 10).style("fill", "black");*/
    //var otherCircles = g.selectAll("rectangle")
      .data(collection.features)
      .enter().append("circle").attr("r", 10);


    var feature = g.selectAll("circle")
      .data(collection.features)
      .enter().append("circle").attr("r", 10);
      //.append("circle").attr("r", 2);

      var totalEvictions = 0;
       var counterTime = 861667200000;
       var initialZoom = Math.pow(2,13);//used to scale dot size
       var timer;

        $( "#slider" ).slider({ max: 1357167200000, min:counterTime, start: function( event, ui ) {
         clearInterval(timer);

      }, change: function( event, ui ) {
        counterTime = $( "#slider" ).slider( "value" );
       // currDate = new Date(f.time).getUTCFullYear();
        
         updateMap();
        // update
         // updateMap($( "#slider" ).slider( "value" ));
      
      }, slide: function( event, ui ) {
        counterTime = $( "#slider" ).slider( "value" );
        updateMap();
       
      }, stop: function( event, ui ) {
        playAnimation();
      }
     });
     playAnimation();

    function updateMap(){
      feature
      .attr("r", 0)

      .filter(function(d) { return Date.parse(d.properties.date_filed) < counterTime}) 
         .style("fill-opacity", 0.7)
       .attr("r", 3)
       .filter(function(d) { return Date.parse(d.properties.date_filed) > counterTime-animationTime}) 
       .style("fill", "red")
      .attr("r", function(d){ 
      var dt = counterTime - Date.parse(d.properties.date_filed);
        totalEvictions++;
          var tt = dt/animationTime;
          var r = 1 + 20* Math.sqrt(tt);
          return r*3*Math.pow(2,map.getZoom())/initialZoom;
         })
        .style("fill-opacity", function(d){
        var dt = counterTime - Date.parse(d.properties.date_filed);
      var interpol_time = animationTime*1.2;
          var a= (1 - dt/interpol_time);
          return Math.max(0, a*a)*0.8;
      }) ;
        currDate = new Date(counterTime).getUTCFullYear();
        document.getElementById('date').innerHTML = currDate;
         document.getElementById('counter').innerHTML = "Total Ellis Act evictions: " +totalEvictions;
         totalEvictions = 0;
    }

     function playAnimation(){
        counterTime = $( "#slider" ).slider( "value" );
        timer = setInterval(function() {

       counterTime += 500000000; 
        $( "#slider" ).slider( "value", counterTime);
         if(parseFloat(currDate) > 2013){
          //alert("too much time" + currDate);
         // alert(f.time);
          clearInterval(timer);
          
         }
        //.replace(/GMT.*/g,'');
      },20);

      }


    function update() {
      feature.attr("cx",function(d) { return map.latLngToLayerPoint(d.LatLng).x})
      feature.attr("cy",function(d) { return map.latLngToLayerPoint(d.LatLng).y})
        updateMap();
      //feature.attr("r",function(d) { return d.properties.count/1400*Math.pow(2,map.getZoom())})
    }
    map.on("viewreset", update);
    update();
})
 

    </script>
  </body>
</html>